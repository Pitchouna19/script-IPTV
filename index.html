<!DOCTYPE html>
<html lang="fr">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Clients MQTT</title>
      <style>
         body {
         font-family: Arial, sans-serif;
         margin: 0;
         padding: 0;
         }
         .top-bar {
         background-color: #333;
         color: white;
         padding: 10px;
         text-align: center;
         display: flex;
         justify-content: center;
         flex-wrap: wrap;
         }
         .top-bar button {
         background-color: #444;
         color: white;
         border: none;
         padding: 10px 20px;
         margin: 5px;
         cursor: pointer;
         border-radius: 5px;
         flex: 1;
         min-width: 120px;
         }
         .top-bar button.active {
         background-color: #007bff;
         }
         .top-bar button:hover {
         background-color: #555;
         }
         .content {
         padding: 20px;
         display: flex;
         flex-direction: column;
         }
         .client-container {
         background-color: #f9f9f9;
         padding: 15px;
         border-radius: 10px;
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         margin-bottom: 20px;
         display: flex;
         flex-direction: column;
         }
         .progress-bar {
         width: 100%;
         background-color: #e0e0e0;
         border-radius: 5px;
         overflow: hidden;
         margin: 5px 0;
         }
         .progress-bar div {
         height: 20px;
         text-align: center;
         color: white;
         line-height: 20px;
         border-radius: 5px;
         }
         .progress-bar.cpu-load div {
         background-color: #007bff;
         }
         .progress-bar.network-in div {
         background-color: #dc3545;
         }
         .progress-bar.network-out div {
         background-color: #fd7e14;
         }
         .progress-with-label {
         display: flex;
         align-items: center;
         margin: 5px 0;
         justify-content: space-between;
         }
         .progress-with-label .label {
         width: 150px;
         white-space: nowrap;
         font-weight: bold;
         }
         .progress-with-label .progress-bar {
         flex-grow: 1;
         margin-left: 10px;
         }
         .progress-container {
         flex: 2;
         }
         .info-client-container {
         display: grid;
         grid-template-columns: repeat(2, 1fr);
         grid-template-rows: repeat(2, 1fr);
         gap: 10px;
         padding: 10px;
         flex: 1;
         }
         .info-client-container button {
         width: 100%;
         padding: 10px;
         background-color: #f1f1f1;
         border: 1px solid #ccc;
         border-radius: 5px;
         cursor: pointer;
         text-align: center;
         font-weight: bold;
         }
         /* Media Queries pour les écrans plus petits */
         @media (max-width: 768px) {
         .top-bar {
         flex-direction: column;
         }
         .client-container {
         flex-direction: column;
         }
         .progress-with-label {
         flex-direction: column;
         align-items: flex-start;
         }
         .progress-with-label .label {
         width: auto;
         }
         }
         @media (max-width: 480px) {
         /* Pas de modifications nécessaires ici */
         }
      </style>
   </head>
   <body>
      <div class="top-bar">
         <button id="dashboard-btn" class="active" onclick="showPage('dashboard')">Dashboard</button>
         <button id="setting1-btn" onclick="showPage('setting1')">Setting 1</button>
         <button id="setting2-btn" onclick="showPage('setting2')">Setting 2</button>
      </div>
      <div class="content">
         <div id="dashboard">
            <div id="clientData">
               <p>Chargement des données...</p>
            </div>
         </div>
         <iframe id="setting1-iframe" style="display: none; width: 100%; height: 500px; border: none;"></iframe>
         <div id="setting2" style="display: none;"></div>
      </div>
      <script>
         let maxTrafficIn = 2; // en Mo
         let maxTrafficOut = 2; // en Mo
         
         function adjustMaxTraffic(currentTraffic, maxTraffic) {
             while (currentTraffic > maxTraffic) {
                 maxTraffic *= 2;
             }
             while (currentTraffic < maxTraffic / 2 && maxTraffic > 2) {
                 maxTraffic /= 2;
             }
             return maxTraffic;
         }
         
         let monitoringData = {};
         
         function loadMonitoringData() {
             console.log('Chargement des données de monitoring...');
             const url = '/monitoring.json?' + new Date().getTime();
             fetch(url)
                 .then(response => {
                     if (!response.ok) {
                         throw new Error('Réponse du réseau non valide');
                     }
                     return response.json();
                 })
                 .then(servers => {
                     console.log('Données de monitoring chargées:', servers);
                     servers.forEach(server => {
                         const serverIp = server.server;
                         if (server.vhosts.length > 0) {
                             const vhost = server.vhosts[0];
                             monitoringData[serverIp] = {
                                 con_clients: vhost.clients -1,
                                 con_streams: vhost.streams
                             };
                         } else {
                             monitoringData[serverIp] = { con_clients: 0, con_streams: 0 };
                         }
                     });
                 })
                 .catch(error => {
                     console.error('Erreur lors du chargement des données de monitoring:', error);
                 });
         }
         
         function loadClientData() {
             console.log('Chargement des données des clients...');
             const url = '/clients.json?' + new Date().getTime();
             fetch(url)
                 .then(response => {
                     if (!response.ok) {
                         throw new Error('Réponse du réseau non valide');
                     }
                     return response.json();
                 })
                 .then(clients => {
                     console.log('Données chargées:', clients);
                     let output = '<h2>Liste des Clients MQTT</h2>';
                     clients.forEach(client => {
                         maxTrafficIn = adjustMaxTraffic(client.network_in, maxTrafficIn);
                         maxTrafficOut = adjustMaxTraffic(client.network_out, maxTrafficOut);
         
                         const inPercentage = (client.network_in / maxTrafficIn) * 100;
                         const outPercentage = (client.network_out / maxTrafficOut) * 100;
         
                         const monitoringInfo = monitoringData[client.ip] || { con_streams: 0, con_clients: 0 };
         
                         output += `
                         <div class="client-container">
                             <div class="progress-container">
                                 <p><strong>IP:</strong> ${client.ip}</p>
         
                                 <!-- Charge CPU -->
                                 <div class="progress-with-label">
                                     <div class="label">Charge CPU:</div>
                                     <div class="progress-bar cpu-load">
                                         <div style="width: ${client.cpu_load}%;">${client.cpu_load}%</div>
                                     </div>
                                 </div>
         
                                 <!-- Trafic IN -->
                                 <div class="progress-with-label">
                                     <div class="label">Trafic IN:</div>
                                     <div class="progress-bar network-in">
                                         <div style="width: ${inPercentage}%;">${client.network_in} Mo</div>
                                     </div>
                                 </div>
         
                                 <!-- Trafic OUT -->
                                 <div class="progress-with-label">
                                     <div class="label">Trafic OUT:</div>
                                     <div class="progress-bar network-out">
                                         <div style="width: ${outPercentage}%;">${client.network_out} Mo</div>
                                     </div>
                                 </div>
         
                                 <div class="info-client-container">
                                     <button>Streams: ${monitoringInfo.con_streams}</button>
                                     <button>Clients Connectés: ${Math.max(0, monitoringInfo.con_clients)}</button>                                    
                                 </div>
                             </div>
                         </div>`;
                     });
                     document.getElementById('clientData').innerHTML = output;
                 })
                 .catch(error => {
                     console.error('Erreur lors du chargement des données des clients:', error);
                 });
         }
         
         loadMonitoringData();
         loadClientData();
         setInterval(() => {
             loadMonitoringData();
             loadClientData();
         }, 2000);
         
         function showPage(page) {
         const pages = ['dashboard', 'setting1', 'setting2'];
         pages.forEach(p => {
         if (p === 'setting1') {
            document.getElementById(`${p}-iframe`).style.display = p === page ? 'block' : 'none';
         } else {
            document.getElementById(p).style.display = p === page ? 'block' : 'none';
         }
         document.getElementById(`${p}-btn`).classList.toggle('active', p === page);
         });
         
         if (page === 'setting1') {
         const iframe = document.getElementById('setting1-iframe');
         if (!iframe.src) {
            iframe.src = 'setting.html'; // Charger la page setting.html
         }
         }
         }
         
      </script>
   </body>
</html>
